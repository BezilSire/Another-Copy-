rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSignedIn() { return request.auth != null; }
    function isAdmin() { 
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'; 
    }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }

    // Treasury & Ledger (Admin Managed)
    match /treasury_vaults/{vaultId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    match /ledger/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    match /globals/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Bridge & Liquidation (Admin Verified)
    match /pending_ubt_purchases/{docId} {
      allow read, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }
    match /sell_requests/{docId} {
      allow read, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn(); // Agents claim, Admins settle
      allow delete: if isAdmin();
    }

    // Identity & Wallets
    match /users/{userId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isOwner(userId) || isAdmin();

      match /notifications/{id} { allow read, write: if isOwner(userId) || isAdmin(); }
      match /transactions/{id} { allow read, write: if isOwner(userId) || isAdmin(); }
      match /vaults/{id} { allow read, write: if isOwner(userId) || isAdmin(); }
    }

    // Community Content
    match /posts/{postId} {
      allow read, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isAdmin() || (isSignedIn() && resource.data.authorId == request.auth.uid);
      match /comments/{id} { allow read, write: if isSignedIn(); }
    }
    
    match /conversations/{convoId} {
      allow read, write: if isSignedIn();
      match /messages/{id} { allow read, write: if isSignedIn(); }
    }

    match /members/{id} { allow read, create: if isSignedIn(); allow update, delete: if isAdmin(); }
    match /proposals/{id} { allow read, create, update: if isSignedIn(); }
    match /ventures/{id} { allow read, create, update: if isSignedIn(); allow delete: if isAdmin(); }
    match /payouts/{id} { allow read, create: if isSignedIn(); allow update: if isAdmin(); }
    match /sustenance_cycles/{id} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /sustenance_vouchers/{id} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /activity/{id} { allow read: if isSignedIn(); allow write: if isSignedIn(); }
    match /reports/{id} { allow read, write: if isAdmin() || isSignedIn(); }
  }
}