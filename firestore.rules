
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    
    // Check if user is logged in
    function isSignedIn() {
      return request.auth != null;
    }

    // Check if the user is accessing their own document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Check if the user has the 'admin' role
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Check if the user has the 'agent' role
    function isAgent() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'agent';
    }

    // --- Collection Rules ---

    // 1. Users Collection
    match /users/{userId} {
      // Anyone signed in can read profiles (needed for search, chat, feed)
      allow read: if isSignedIn();
      
      // Creation is allowed for signups
      allow create: if isSignedIn();
      
      // Update Logic:
      // 1. Owner can update their own profile.
      // 2. Admin can update anything (roles, status).
      // 3. Any user can update 'followers' (to follow someone).
      allow update: if isOwner(userId) 
                    || isAdmin()
                    || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followers']));
      
      // Only Admin can delete users (soft delete preferred usually, but this is allowed)
      allow delete: if isAdmin();

      // 1a. User Notifications (Subcollection)
      match /notifications/{notificationId} {
        // Owner can read their notifications
        allow read: if isOwner(userId);
        // Anyone can CREATE a notification (e.g. "X followed you", "Y liked your post")
        allow create: if isSignedIn();
        // Owner can update (mark as read)
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      // 1b. User Transactions (Subcollection)
      match /transactions/{txId} {
        // Owner and Admin can read
        allow read: if isOwner(userId) || isAdmin();
        // Admin or System (via Client SDK for MVP) can write
        allow write: if isOwner(userId) || isAdmin(); 
      }
    }

    // 2. Members Collection (Registry)
    match /members/{memberId} {
      allow read: if isSignedIn();
      // Agents create members, Admins/Owner update
      allow write: if isSignedIn(); 
    }

    // 3. Posts Collection
    match /posts/{postId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      
      // Update: 
      // 1. Author can edit content.
      // 2. Admin can pin/edit.
      // 3. Anyone can update 'upvotes', 'commentCount', 'repostCount' (interactions).
      allow update: if resource.data.authorId == request.auth.uid 
                    || isAdmin()
                    || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotes', 'commentCount', 'repostCount', 'repostedFrom']));
      
      allow delete: if resource.data.authorId == request.auth.uid || isAdmin();

      // 3a. Comments (Subcollection)
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        // Author or Admin can delete. Anyone can upvote.
        allow update: if resource.data.authorId == request.auth.uid 
                      || isAdmin() 
                      || (isSignedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotes']));
        allow delete: if resource.data.authorId == request.auth.uid || isAdmin();
      }
    }

    // 4. Conversations (Chat)
    match /conversations/{conversationId} {
      // Only members of the chat can read/write
      allow read: if resource.data.members.hasAny([request.auth.uid]);
      allow create: if isSignedIn();
      allow update: if resource.data.members.hasAny([request.auth.uid]);

      // 4a. Messages
      match /messages/{messageId} {
        // We rely on the parent conversation security, but explicitly:
        // Ideally we check parent, but standard firestore rules don't easily reach parent data without a get().
        // For MVP, we allow signed in users to write to known conversation IDs if they know the ID.
        // A stricter rule would get() the parent.
        allow read, write: if isSignedIn(); 
      }
    }

    // 5. Broadcasts
    match /broadcasts/{broadcastId} {
      allow read: if isSignedIn();
      allow write: if isAgent() || isAdmin();
    }

    // 6. Reports
    match /reports/{reportId} {
      allow read: if isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin();
    }

    // 7. Activity
    match /activity/{activityId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // 8. Proposals
    match /proposals/{proposalId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      // Allow voting (updating votesFor/votesAgainst)
      allow update: if isSignedIn(); 
      
      // 8a. Proposal Comments
      match /comments/{commentId} {
        allow read, write: if isSignedIn();
      }
    }

    // 9. Ventures
    match /ventures/{ventureId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if resource.data.ownerId == request.auth.uid || isAdmin() || isSignedIn(); // Allow updates for funding backers
      allow delete: if resource.data.ownerId == request.auth.uid || isAdmin();
      
      match /distributions/{distId} {
        allow read: if isSignedIn();
      }
    }

    // 10. Payouts
    match /payouts/{payoutId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if isOwner(request.resource.data.userId);
      allow update: if isAdmin() || isOwner(resource.data.userId);
    }

    // 11. Globals (Economy, CVP)
    match /globals/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // 12. Sustenance
    match /sustenance_cycles/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    match /sustenance_vouchers/{voucherId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow update: if isAdmin() || isSignedIn(); // For redemption by vendors
    }
    
    // 13. Price Verifications
    match /price_verifications/{docId} {
        allow read: if isAdmin();
        allow create: if isSignedIn();
    }
  }
}
